# Фильтрация топонимов на карте

## Обзор реализации

Была реализована система фильтрации топонимов на странице карты (`/[locale]/map`) с использованием Next.js 15, серверных компонентов и современного UI в соответствии с предоставленным дизайном.

## Функциональность

### Фильтры
- **Поиск по названию** (`search`) - текстовый поиск топонимов
- **Алфавитная панель** (`startswith`) - фильтрация по первой букве (кириллица + латиница)
- **Язык** (`language`) - выбор языка топонимов
- **Территориальные фильтры** (множественный выбор):
  - Регионы (`region`)
  - Районы (`district`) 
  - Города (`city`)
  - Айылы (`aiyl`)
  - Айыл айымаки (`aiyl_aimak`)
  - Специальные территории (`special_territory`)
- **Пласты** (`plast`) - геологические пласты
- **Сортировка** (`ordering`) - порядок отображения результатов
- **Пагинация** (`limit`, `offset`) - количество результатов на странице

### UI Компоненты

#### FilterPanel
- **Расположение**: Правый верхний угол карты
- **Адаптивность**: На мобильных устройствах - полноэкранная панель
- **Функции**:
  - Счетчик активных фильтров в кнопке
  - Алфавитная панель для быстрого фильтра
  - Группировка фильтров (сворачиваемые секции)
  - Отображение выбранных фильтров в виде "чипов"
  - Кнопка "Открыть все фильтры"
  - Кнопка "Очистить все"

#### ResultsInfo
- **Расположение**: Нижняя часть карты
- **Функции**:
  - Счетчик найденных топонимов
  - Пагинация с номерами страниц
  - Информация о текущем диапазоне результатов
  - Состояния загрузки и ошибок

### API Endpoints

#### Основной API
- `GET /api/toponyms` - получение топонимов с фильтрацией
  - Поддерживает все query параметры из swagger документации
  - Фильтрует только топонимы с координатами
  - Возвращает стандартную пагинированную структуру

#### Справочники
- `GET /api/directories/languages` - языки
- `GET /api/directories/plast` - пласты  
- `GET /api/territories/regions` - регионы
- `GET /api/territories/districts` - районы
- `GET /api/territories/cities` - города
- `GET /api/territories/aiyls` - айылы
- `GET /api/territories/aiyl-aimaks` - айыл айымаки
- `GET /api/territories/special-territories` - спец. территории

### Технические особенности

#### Архитектура
- **Server Components**: FilterPanel загружает справочники на сервере
- **Client Components**: FilterForm обрабатывает пользовательский ввод
- **Query Parameters**: Синхронизация состояния фильтров с URL
- **Debouncing**: Оптимизация поисковых запросов

#### Состояние фильтров
- Полная синхронизация с URL query параметрами
- Поддержка массивов для множественного выбора
- Автоматическое обновление карты при изменении фильтров
- Сохранение состояния при навигации

#### Обработка ошибок
- Graceful fallback при недоступности API
- Пустые массивы как fallback для справочников
- Информативные сообщения об ошибках
- Loading состояния для всех запросов

## Файловая структура

```
src/
├── app/
│   ├── [locale]/map/
│   │   └── page.jsx                 # Страница карты
│   └── api/
│       ├── toponyms/route.js        # Основной API топонимов
│       ├── directories/             # API справочников
│       └── territories/             # API территорий
├── components/
│   ├── FilterPanel/
│   │   ├── FilterPanel.jsx          # Server component
│   │   ├── FilterForm.jsx           # Client component  
│   │   ├── FilterPanel.module.scss  # Стили
│   │   └── index.jsx
│   ├── Map/
│   │   ├── CountryMap.jsx          # Карта с интеграцией фильтров
│   │   └── MapClient.jsx           # Динамический импорт
│   └── ResultsInfo/
│       ├── ResultsInfo.jsx         # Компонент пагинации
│       ├── ResultsInfo.module.scss # Стили
│       └── index.js
```

## Соответствие дизайну

✅ Алфавитная панель (кириллица + латиница)  
✅ Чипы выбранных фильтров с возможностью удаления  
✅ Счетчик применённых фильтров  
✅ Сворачиваемые группы фильтров  
✅ Кнопка "Открыть все фильтры"  
✅ Адаптивный дизайн для мобильных устройств  
✅ Пагинация результатов  
✅ Информация о количестве найденных топонимов  

## Использование

1. Откройте страницу `/[locale]/map`
2. Нажмите кнопку "Фильтры" в правом верхнем углу
3. Настройте нужные фильтры:
   - Используйте алфавитную панель для быстрого фильтра
   - Выберите территориальные фильтры через чекбоксы
   - Введите поисковый запрос
4. Фильтры автоматически применяются к карте
5. Используйте пагинацию внизу для навигации по результатам
6. Очистите фильтры кнопкой "Очистить все" или удалите отдельные чипы

Все изменения синхронизируются с URL, что позволяет делиться ссылками с конкретными фильтрами.
